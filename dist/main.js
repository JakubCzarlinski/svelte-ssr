// @bun
import ZV from"command-line-args";import{chdir as $V,cwd as LV}from"process";import{copyFileSync as NV,existsSync as j,mkdirSync as K,readdirSync as AV,rmdirSync as BV,writeFile as k}from"fs";import{cwd as qV}from"process";import U from"path";import r from"@fullhuman/postcss-purgecss";import p from"@rollup/plugin-node-resolve";import{svelte as h,vitePreprocess as d}from"@sveltejs/vite-plugin-svelte";import n from"autoprefixer";import{readFileSync as l,writeFileSync as i}from"fs";import Z from"path";import{preprocess as a}from"svelte/compiler";import{render as o}from"svelte/server";import t from"tailwindcss";import{defineConfig as e}from"vite";import{parse as _}from"@/node_modules/svelte/src/compiler/phases/1-parse/index.js";import{remove_typescript_nodes as $}from"@/node_modules/svelte/src/compiler/phases/1-parse/remove_typescript_nodes.js";import{analyze_component as E}from"@/node_modules/svelte/src/compiler/phases/2-analyze/index.js";import{transform_component as w}from"@/node_modules/svelte/src/compiler/phases/3-transform/index.js";import{reset as C,reset_warning_filter as y}from"@/node_modules/svelte/src/compiler/state.js";import{validate_component_options as x}from"@/node_modules/svelte/src/compiler/validate-options.js";import{walk as u}from"estree-walker";import S from"path";import{walk as F}from"zimmerframe";function R(I,J,V,G){y(J.warningFilter);const M=x(J,"");C(I,M);let H=_(I);const{customElement:A,...N}=H.options||{},B={...M,...N,customElementOptions:A};if(H=f(H,V,G),H.metadata.ts)H={...H,fragment:H.fragment&&$(H.fragment),instance:H.instance&&$(H.instance),module:H.module&&$(H.module)};const q=E(H,I,B),Q=w(q,I,B);return Q.ast=v(H),Q}function v(I){const J=(V)=>{delete V.metadata,delete V.parent};return I.options?.attributes.forEach((V)=>{if(J(V),J(V.value),Array.isArray(V.value))V.value.forEach(J)}),F(I,null,{_(V,{next:G}){J(V),G()}})}function f(I,J,V){return u(I,{enter(G,M){if(G.type==="ImportDeclaration"){if(!G.source.value||!G.source.raw)return;if(G.source.value.match(L))G.source.value=G.source.value.replace(L,(A,N,B)=>{return Y(N,J,"js",V)}),G.source.raw=G.source.raw.replace(L,(A,N,B)=>{return Y(N,J,"js",V)}),G.source.value=G.source.value.replace(O,(A,N,B)=>{return Y(N,J,B,V)}),G.source.raw=G.source.raw.replace(O,(A,N,B)=>{return Y(N,J,B,V)});else{const A=import.meta.require.resolve(G.source.value,{paths:[S.dirname(J)]}),N=S.relative(S.dirname(J),A).replaceAll(S.sep,S.posix.sep);G.source.value=`../${N}`,G.source.raw=`"../${N}"`}}}})}function Y(I,J,V,G){return`./${S.relative(S.dirname(J),S.join(I)).replaceAll(S.sep,S.posix.sep).replaceAll(G,"")}.${V}`}var L=/@\/([a-zA-Z0-9_\/]+)\.(svelte)(?!\.)/g,O=/@\/([a-zA-Z0-9_\/]+)\.(mjs|cjs|js)/g;function c(I){return I.replaceAll(P,(J,V,G)=>G)}function s(I){return I.replaceAll(m,(J,V,G)=>G)}function W(){return{markup({content:I}){return{code:c(s(I))}}}}var m=/<!--\s+CSR\s+-->([\s\S]*?)<!--\s+SSR\s+-->([\s\S]*?)<!--\s+END\s+-->/gm,P=/\/\/\s+CSR\s*([\s\S]*?)\/\/\s+SSR\s*([\s\S]*?)\/\/\s+END/gm;function GV(I){if(z)return z;else if(I)return D(I);else throw new Error("Preprocessor config not set")}function D(I){return z=[W(),d({style:e({plugins:[VV,r({})],css:{postcss:{plugins:[t(I),n()]}},resolve:{alias:{"@":Z.resolve(__dirname,"./")}},build:{commonjsOptions:{include:[/linked-dep/,/node_modules/]},ssr:!0,rollupOptions:{input:"./index.html",output:{entryFileNames:"assets/[name].js",chunkFileNames:"assets/[name].js",assetFileNames:"assets/[name].[ext]"},plugins:[p({browser:!0,exportConditions:["svelte"],extensions:[".svelte"]})]}}})})]}async function b(I,J,V,G,M){let H=l(I,"utf8");if(V){const q=H.match(IV),Q=`<link rel="modulepreload" as="script" href="/assets/${Z.basename(J)}"/>`;if(q)H=H.replace(q[0],`${q[0]}\n${Q}`);else H=H.concat(`<svelte:head>${Q}</svelte:head>`)}const A=Z.basename(I),{code:N}=await a(H,GV(),{filename:A}),{js:B}=R(N,{filename:A,generate:"ssr",dev:!1,discloseVersion:!1,modernAst:!0},J.replace(G,""),M);return new Promise((q)=>{i(J,B.code),q(!0)})}async function g(I){const J=(await import(Z.join(process.cwd(),I))).default,V=o(J,{});V.head=V.head.replaceAll(HV,"");const G=new Set;let M;while(M=JV.exec(V.head))G.add(M[0]);return V.head=Array.from(G).join("\n"),V.html=V.html.replaceAll(MV,""),V}var __dirname="C:\\Users\\Jakub\\Documents\\GitHub\\svelte-ssr\\rendering",VV=h({compilerOptions:{modernAst:!0},prebundleSvelteLibraries:!0}),z=null,IV=/<svelte:head>([\s\S]*?)<\/svelte:head>/,JV=/<[^>]+>/g,HV=/<!--[\s\S]*?-->/g,MV=/<link rel="modulepreload" as="script" href="\/assets\/(.*?).js">/gm;async function T({componentPath:I,compilePath:J,tailwindConfig:V,clean:G}){const M=new Promise((q)=>{import(U.join(qV(),V)).then((Q)=>{q(Q.default)})});if(!j(J))K(J,{recursive:!0});else if(G)BV(J,{recursive:!0}),K(J,{recursive:!0});const H=AV(I,{recursive:!0,withFileTypes:!0}),A=YV(H,I),N=[],B=[];for(let q of A){const Q=U.dirname(q);if(Q!=="."){const X=U.join(J,Q);if(!j(X))K(X,{recursive:!0})}if(q.endsWith(".svelte")){N.push(q);continue}B.push(new Promise((X)=>{NV(`${I}${q}`,`${J}${q}`),X(!0)}))}await Promise.all(B),D(await M),await XV(N,I,J),await SV(N,J)}function SV(I,J){const V=[];for(let G=0;G<I.length;G++){const M=J+I[G].split(".")[0];V.push(g(M+".js").then(async(H)=>{await UV(H,M)}))}return Promise.all(V)}function UV(I,J){let V=0;const G=(M)=>{if(V++,V===2)return M(!0)};return new Promise((M)=>{k(J+".html",I.html,()=>G(M)),k(J+".head",I.head,()=>G(M))})}function XV(I,J,V){const G=[];for(let M=0;M<I.length;M++){const H=I[M],A=H.split(".")[0],N=J+H,B=V+A+".js";G.push(b(N,B,!0,V,J.slice(2)))}return Promise.all(G)}function YV(I,J){let V="",G="",M="";const H=[];for(let A=0;A<I.length;A++){const N=I[A];if(!N.isFile())continue;for(let B of QV){if(!N.name.endsWith(B))continue;if(G=N.parentPath.replaceAll(U.sep,U.posix.sep).replaceAll(J.slice(2,-1),""),V=N.name.replaceAll(U.sep,U.posix.sep),V.startsWith("/"))V=V.slice(1);if(M=U.join(G,V).replaceAll(U.sep,U.posix.sep),M.startsWith("/"))M=M.slice(1);H.push(M);break}}return H}var QV=[".svelte",".js",".cjs",".mjs",".css",".html",".json"];var zV=[{name:"componentPath",type:String,alias:"i",defaultValue:"./src/lib/"},{name:"compilePath",type:String,alias:"o",defaultValue:"./compile/"},{name:"tailwindConfig",type:String,alias:"t",defaultValue:"tailwind.config.ts"},{name:"clean",type:Boolean,alias:"c",defaultValue:!1}],DV=ZV(zV);$V(LV());T(DV);
